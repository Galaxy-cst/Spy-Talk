<!doctype html>
<html class="no-js">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="author" content="GLTLAB">
  <meta name="description" content="SPY-TALK.NET">
  <meta name="keywords" content="SPY-TALK 隐私保护 信息传递">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Access-Control-Allow-Origin" content="https://spy-talk.net">
  <title>SPY-TALK</title>

  <!-- Set render engine for 360 browser -->
  <meta name="renderer" content="webkit">

  <!-- No Baidu Siteapp-->
  <meta http-equiv="Cache-Control" content="no-siteapp" />

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Amaze UI" />

  <!-- Tile icon for Win8 (144x144 + tile color) -->
  <meta name="msapplication-TileColor" content="#0e90d2">

  <link rel="stylesheet" href="assets/css/amazeui.min.css">
  <link rel="stylesheet" href="assets/css/app.css">
  <link rel="stylesheet" href="assets/css/typeit.min.css">
  <!--[if (gte IE 9)|!(IE)]><!-->
  <script src="assets/js/jquery.min.js"></script>
  <!--<![endif]-->
  <!--[if lte IE 8 ]>
<script src="http://libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="assets/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->
  <script src="assets/js/amazeui.min.js"></script>
  <script src="assets/js/typeit.min.js"></script>
  <script src="assets/js/peer.js"></script>
  <style>
    div#img1 {
      display: none
    }

    ;
  </style>
  <script src="pass.js"></script>
  <script>
    function load() {
      type1();
    }

    function type1() {
      $('.mainp1').typeIt({
        whatToType: ["SPY-TALK在线聊天室", "风过无声   雁过无痕"],
        typeSpeed: 250,
        breakLines: false,
        lifeLike: true,
        showCursor: true,
        breakWait: 1500

      });
    }
  </script>
</head>

<body onload="load()">
  <header data-am-widget="header" class="am-header am-header-default" data-am-sticky>
    <div class="am-header-left am-header-nav">
      <a href="" class="">
                <span class="am-header-nav-title">
                主页
              </span>

                <i class="am-header-icon am-icon-home"></i>
            </a>
    </div>

    <h1 class="am-header-title" id="title">
          主页
      </h1>

    <div class="am-header-right am-header-nav">
      <div class="am-dropdown" data-am-dropdown>
        <button class="am-btn am-btn-primary am-dropdown-toggle" data-am-dropdown-toggle>
      <span class="am-header-nav-title">目录</span>
      <i class="am-header-icon am-icon-bars"></i>
    </button>
        <ul class="am-dropdown-content" onblur="$('.am-dropdown').dropdown('close');" onfocus="$('.am-dropdown').dropdown('close');">
          <li class="am-dropdown-header">简介</li>
          <li class="am-divider"></li>
          <li><a href="/">欢迎页</a></li>
          <li><a href="javascript:mov('SPY的原理');">SPY的原理</a></li>
          <li class="am-disabled"><a href="javascript:;">源代码</a></li>
          <li class="am-divider"></li>
          <li class="am-dropdown-header">开启SPY旅程</li>
          <li class="am-divider"></li>
          <li><a href="javascript:mov('新建');">新建</a></li>
          <li><a href="javascript:mov('接收方');">接收方</a></li>
          <li class="am-divider"></li>
          <li class="am-dropdown-header">更多……</li>
          <li class="am-divider"></li>
          <li><a href="javascript:;" data-am-modal="{target: '#your-modal', closeViaDimmer: 0}">捐赠</a></li>
          <li><a href="javascript:mov('建议&意见');">建议&意见</a></li>
          <li class="am-divider"></li>
          <li class="am-dropdown-header">我们的社区</li>
          <li class="am-divider"></li>
          <li><a href="http://tieba.baidu.com/f?kw=spy_talk" target="_blank">贴吧</a></li>
          <li><a href="https://coding.net/u/lightning/p/spy-talk2.0/git" target="_blank">Coding</a></li>
          <li class="am-disabled"><a href="">独立论坛</a></li>
        </ul>
      </div>

    </div>
  </header>
  <div id="animation">
    <div id="mainbody">
      <div class="am-g">
        <div class="am-u-sm-6 am-u-sm-centered" id="head">
          <br>
          <h2 align="center">SPY-TALK</h2>
          <hr data-am-widget="divider" style="" class="am-divider am-divider-default" />
          <hr data-am-widget="divider" style="" class="am-divider am-divider-default" />
          <p align="center" class="mainp1"></p>
          <br>
        </div>
        <div class="am-u-sm-12 am-u-sm-centered">

          <section class="am-panel am-panel-success">
            <header class="am-panel-hd">
              <h3 class="am-panel-title"><span id="codeinfo"></span></h3>
            </header>
            <div class="am-panel-bd">
              <ul class="am-comments-list am-comments-list-flip" style="height:400px;overflow-y:auto;" id="talktable"></ul>
            </div>
            <footer class="am-panel-footer">
              <div class="am-input-group">
                <input type="text" class="am-form-field" id="sender" placeholder="输入标识符建立连接" onkeypress="BindEnter(event)">
                <span class="am-input-group-btn">
        <button class="am-btn am-btn-default" type="button" onclick="a()">发送</button>
      </span>
              </div>
            </footer>
          </section>
        </div>
      </div>
    </div>
  </div>
  <hr data-am-widget="divider" style="" class="am-divider am-divider-dotted" />
  <footer data-am-widget="footer" class="am-footer am-footer-default" data-am-footer="{  }">
    <div class="am-footer-miscs ">

      <p>由 <a href="http://GLTLAB.com/" title="GLTLAB" target="_blank" class="">GLTLAB</a> 创建
      </p><br>
      <p>CopyRight©2015 SPY-TALK.NET</p>
    </div>
  </footer>

  <script>
    var main = [];
    main['peer'] = [];
    main['me'] = 'Admin';
    // 与服务器建立Peer连接
    var peer = new Peer(randomString(4), {
      host: 'www.prismx.cc',
      port: 9000,
      path: '/',
      debug: 3
    });
    var connectedPeers = {};

    // 回显peer连接的ID
    peer.on('open', function(id) {
      $('#codeinfo').html("您的会话临时ID是" + id);
      main['me'] = id;
    });

    // 等待主动连接
    peer.on('connection', connect);

    peer.on('error', function(err) {
      console.log(err);
      alert("内部错误产生，请重新尝试");
    })

    // 处理主动连接
    function connect(c) {
      // 处理会话
      if (c.label === 'chat') {
        $("#codeinfo").html("与" + c.peer + "建立连接成功");
        main['peer'].push(c.peer);
        $("#sender").val("");

        c.on('data', function(data) {
          addhtmlto(c.peer, data);
          $("#talktable").animate({
            scrollTop: $("#talktable")[0].scrollHeight
          }, 1000);
        });
        c.on('close', function() {
          alert("与" + c.peer + "的连接已经断开^.-");
          $("#talktable").html("");
          delete connectedPeers[c.peer];
        });
      } else if (c.label === 'file') {
        c.on('data', function(data) {
          // 处理接收的文件
          if (data.constructor === ArrayBuffer) {
            var dataView = new Uint8Array(data);
            var dataBlob = new Blob([dataView]);
            var url = window.URL.createObjectURL(dataBlob);
            addhtmlto(c.peer, '对方发送给您一个<a target="_blank" href="' + url + '" download="download">文件</a>.</span></div>');
            $("#talktable").animate({
              scrollTop: $("#talktable")[0].scrollHeight
            }, 1000);
          }
        });
      }
      connectedPeers[c.peer] = 1;
    }

    $(document).ready(function() {
      // 激活拖拽文件上传功能
      var box = $('#talktable');
      box.on('dragenter', doNothing);
      box.on('dragover', doNothing);
      box.on('drop', function(e) {
        e.originalEvent.preventDefault();
        var file = e.originalEvent.dataTransfer.files[0];
        eachActiveConnection(function(c) {
          if (c.label === 'file') {
            c.send(file);
            addhtmlme('您发送了一个文件至' + c.peer);
            $("#talktable").animate({
              scrollTop: $("#talktable")[0].scrollHeight
            }, 1000);
          }
        });
      });

      function doNothing(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // 浏览器信息提示
      addhtmlme("您的浏览器信息是：" + navigator.userAgent);
    });
    //垃圾处理
    window.onunload = window.onbeforeunload = function(e) {
      if (!!peer && !peer.destroyed) {
        peer.destroy();
      }
    };

    // 建立P2P连接
    function connectto() {
      var requestedPeer = $("#sender").val();
      if (!connectedPeers[requestedPeer]) {
        // Create 2 connections, one labelled chat and another labelled file.
        var c = peer.connect(requestedPeer, {
          label: 'chat',
          serialization: 'none',
          metadata: {
            message: 'hi i want to chat with you!'
          }
        });
        c.on('open', function() {
          connect(c);
        });
        c.on('error', function(err) {
          alert(err);
        });
        var f = peer.connect(requestedPeer, {
          label: 'file',
          reliable: true
        });
        f.on('open', function() {
          connect(f);
        });
        f.on('error', function(err) {
          alert(err);
        });
      }
      connectedPeers[requestedPeer] = 1;
    }

    function a() {
      if (!main['peer'].length) {
        connectto();
      } else {
        var msg = $("#sender").val();
        eachActiveConnection(function(c) {
          if (c.label === 'chat') {
            c.send(msg);
            addhtmlme(msg);
            $("#sender").val("");
            $("#talktable").animate({
              scrollTop: $("#talktable")[0].scrollHeight
            }, 1000);
            $("#sender").focus();
          }
        });
      }
    }

    function eachActiveConnection(fn) {
      var checkedIds = {};
      for (var index in main['peer']) {
        if (main['peer'].hasOwnProperty(index)) {
          var peerId = main['peer'][index];

          if (!checkedIds[peerId]) {
            var conns = peer.connections[peerId];
            for (var i = 0, ii = conns.length; i < ii; i += 1) {
              var conn = conns[i];
              console.log(conn);
              fn(conn);
            }
          }

          checkedIds[peerId] = 1;
        }
      }
    }

    function addhtmlme(valto) {
      $("#talktable").append(
        '<li class="am-comment"><article class="am-comment am-comment-flip am-comment-primary"><div class="am-comment-main"><header class="am-comment-hd"><!--<h3 class="am-comment-title"></h3>--><div class="am-comment-meta"><a href="#link-to-user" class="am-comment-author">' +
        main['me'] + '</a> </div></header><div class="am-comment-bd">' + valto + '</div></div></article></li>');
    }

    function addhtmlto(name, valto) {
      $("#talktable").append('  <li class="am-comment"><article class="am-comment"><div class="am-comment-main"><header class="am-comment-hd"><div class="am-comment-meta">' + name +
        '</div></header><div class="am-comment-bd am-comment-bd-fanyi" onclick="fanyi(this);">' + valto +
        '<span class="am-badge am-badge-secondary am-fr">点击翻译</span></div></div></article></li>');
    }

    function fanyi(e) {
      if ($(e).hasClass("am-comment-bd-fanyi")) {
        $.post(
          "talkto.php", {
            type: "fanyi",
            nr: $(e).html()
          },
          function(data) {
            msg = JSON.parse(data).msg;
            $(e).html(msg);
            $(e).removeClass("am-comment-bd-fanyi");
          }
        );
      }
    }

    function BindEnter(event) {

      if (event.keyCode == 13) {

        event.cancelBubble = true;

        event.returnValue = false;

        a();

      }

    }

    function randomString(len) {　　
      len = len || 32;　　
      var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';　　
      var maxPos = $chars.length;　　
      var pwd = '';　　
      for (i = 0; i < len; i++) {　　　　
        pwd += $chars.charAt(Math.floor(Math.random() * maxPos));　　
      }　　
      return pwd;
    }
  </script>
</body>

</html>